<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker Application Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        label {
            font-weight: bold;
            display: block;
            margin: 10px 0 5px;
        }
        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
        }
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Broker Application</h1>
    <form id="brokerForm">
        <!-- Deal Fields -->
        <label for="brokerEmail">Broker Email Link:</label>
        <input type="email" id="brokerEmail" name="brokerEmail" required>

        <label for="brokerPoints">Requested Broker Points:</label>
        <input type="text" id="brokerPoints" name="brokerPoints" required>

        <label for="brokerRate">Requested Broker Rate:</label>
        <input type="text" id="brokerRate" name="brokerRate" required>

        <label for="propertyAddress">Property Address:</label>
        <input type="text" id="propertyAddress" name="propertyAddress" required>

        <label for="additionalCollateral">Additional Collateral:</label>
        <textarea id="additionalCollateral" name="additionalCollateral" rows="3" required></textarea>

        <label for="loanType">Loan Type:</label>
        <select id="loanType" name="loanType" required>
            <option value="">Select Loan Type</option>
            <option value="Acquisition">Acquisition</option>
            <option value="Construction">Construction</option>
            <option value="Rehab">Rehab</option>
            <option value="Refinance">Refinance</option>
            <option value="NPL">NPL</option>
        </select>

        <label for="loanValue">Loan Amount:</label>
        <input type="number" id="loanValue" name="loanValue" required>

        <label for="loanStory">Loan Story:</label>
        <textarea id="loanStory" name="loanStory" rows="3" required></textarea>

        <label for="exitStrategy">Exit Strategy:</label>
        <textarea id="exitStrategy" name="exitStrategy" rows="3" required></textarea>

        <!-- Person Fields -->
        <label for="personName">Person Name:</label>
        <input type="text" id="personName" name="personName" required>

        <label for="personPhone">Person Phone:</label>
        <input type="text" id="personPhone" name="personPhone" required>

        <!-- Organization Fields -->
        <label for="organizationName">Organization Name (Optional):</label>
        <input type="text" id="organizationName" name="organizationName">

        <!-- Attachments -->
        <label for="attachments">Attachments (Max size: 20MB each):</label>
        <input type="file" id="attachments" name="attachments[]" multiple>

        <button type="submit">Submit</button>
    </form>

    <script>
        document.getElementById('brokerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const apiKey = '29d13bb6f973927d502f37387b65c3a92e7012d5';
            const baseUrl = 'https://api.pipedrive.com/v1';

            // Step 1: Create the Deal
            const dealData = {
                title: "Broker Application",
                person_id: {
                    name: document.getElementById('personName').value,
                    phone: document.getElementById('personPhone').value
                },
                org_id: document.getElementById('organizationName').value ? { name: document.getElementById('organizationName').value } : null,
                custom_fields: {
                    "custom_field_abc123": document.getElementById('brokerEmail').value, // Replace with actual field keys
                    "custom_field_abc124": document.getElementById('brokerPoints').value,
                    "custom_field_abc125": document.getElementById('brokerRate').value,
                    "custom_field_abc126": document.getElementById('propertyAddress').value,
                    "custom_field_abc127": document.getElementById('additionalCollateral').value,
                    "custom_field_abc128": document.getElementById('loanType').value,
                    "custom_field_abc129": document.getElementById('loanValue').value,
                    "custom_field_abc130": document.getElementById('loanStory').value,
                    "custom_field_abc131": document.getElementById('exitStrategy').value
                }
            };

            try {
                const dealResponse = await fetch(`${baseUrl}/deals?api_token=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(dealData)
                });

                const dealResult = await dealResponse.json();

                if (!dealResult.success) {
                    console.error('Error creating deal:', dealResult.error);
                    alert('Deal creation failed. Check console for details.');
                    return;
                }

                const dealId = dealResult.data.id;
                console.log('Deal created successfully:', dealId);

                // Step 2: Upload Attachments
                const attachments = document.getElementById('attachments').files;
                for (let i = 0; i < attachments.length; i++) {
                    if (attachments[i].size > 20 * 1024 * 1024) {
                        alert(`File "${attachments[i].name}" exceeds the 20MB limit.`);
                        return;
                    }

                    const fileData = new FormData();
                    fileData.append('file', attachments[i]);

                    const fileResponse = await fetch(`${baseUrl}/files?api_token=${apiKey}&deal_id=${dealId}`, {
                        method: 'POST',
                        body: fileData
                    });

                    const fileResult = await fileResponse.json();
                    if (!fileResult.success) {
                        console.error('Error uploading file:', fileResult.error);
                        alert('File upload failed. Check console for details.');
                        return;
                    }
                }

                alert('Submission successful!');
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    </script>
</body>
</html>
