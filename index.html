<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broker Application Form</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        label {
            font-weight: bold;
            display: block;
            margin: 10px 0 5px;
        }
        input, select, textarea, button {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
        }
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>Broker Application</h1>
    <form id="brokerForm" enctype="multipart/form-data">
        <!-- Deal Fields -->
        <label for="brokerEmail">Broker Email Link:</label>
        <input type="email" id="brokerEmail" name="brokerEmail" required>

        <label for="brokerPoints">Requested Broker Points:</label>
        <input type="text" id="brokerPoints" name="brokerPoints" required>

        <label for="brokerRate">Requested Broker Rate:</label>
        <input type="text" id="brokerRate" name="brokerRate" required>

        <label for="propertyAddress">Property Address:</label>
        <input type="text" id="propertyAddress" name="propertyAddress" required>

        <label for="additionalCollateral">Additional Collateral:</label>
        <textarea id="additionalCollateral" name="additionalCollateral" rows="3" required></textarea>

        <label for="loanType">Loan Type:</label>
        <select id="loanType" name="loanType" required>
            <option value="">Select Loan Type</option>
            <option value="Acquisition">Acquisition</option>
            <option value="Construction">Construction</option>
            <option value="Rehab">Rehab</option>
            <option value="Refinance">Refinance</option>
            <option value="NPL">NPL</option>
        </select>

        <label for="loanValue">Loan Amount:</label>
        <input type="number" id="loanValue" name="loanValue" required>

        <label for="loanStory">Loan Story:</label>
        <textarea id="loanStory" name="loanStory" rows="3" required></textarea>

        <label for="exitStrategy">Exit Strategy:</label>
        <textarea id="exitStrategy" name="exitStrategy" rows="3" required></textarea>

        <!-- Person Fields -->
        <label for="personName">Person Name:</label>
        <input type="text" id="personName" name="personName" required>

        <label for="personPhone">Person Phone:</label>
        <input type="text" id="personPhone" name="personPhone" required>

        <!-- Organization Fields -->
        <label for="organizationName">Organization Name:</label>
        <input type="text" id="organizationName" name="organizationName">

        <!-- Attachments -->
        <label for="attachments">Attachments (Max size: 20MB each):</label>
        <input type="file" id="attachments" name="attachments[]" multiple>

        <button type="submit">Submit</button>
    </form>

    <script>
        document.getElementById('brokerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const apiKey = '29d13bb6f973927d502f37387b65c3a92e7012d5';
            const baseUrl = 'https://api.pipedrive.com/v1';
            const formData = new FormData();
            const attachments = document.getElementById('attachments').files;

            // Validate file sizes
            for (let i = 0; i < attachments.length; i++) {
                if (attachments[i].size > 20 * 1024 * 1024) {
                    alert(`File "${attachments[i].name}" exceeds the 20MB limit.`);
                    return;
                }
            }

            // Prepare form data
            formData.append('title', 'Broker Application');
            formData.append('custom_fields[broker_email_link]', document.getElementById('brokerEmail').value);
            formData.append('custom_fields[requested_broker_points]', document.getElementById('brokerPoints').value);
            formData.append('custom_fields[requested_broker_rate]', document.getElementById('brokerRate').value);
            formData.append('custom_fields[property_address]', document.getElementById('propertyAddress').value);
            formData.append('custom_fields[additional_collateral]', document.getElementById('additionalCollateral').value);
            formData.append('custom_fields[loan_type]', document.getElementById('loanType').value);
            formData.append('custom_fields[loan_value]', document.getElementById('loanValue').value);
            formData.append('custom_fields[loan_story]', document.getElementById('loanStory').value);
            formData.append('custom_fields[exit_strategy]', document.getElementById('exitStrategy').value);

            // Add person data
            const personName = document.getElementById('personName').value;
            const personPhone = document.getElementById('personPhone').value;
            formData.append('person_name', personName);
            formData.append('person_phone', personPhone);

            // Add optional organization
            const orgName = document.getElementById('organizationName').value;
            if (orgName) {
                formData.append('org_name', orgName);
            }

            // Add attachments
            for (let i = 0; i < attachments.length; i++) {
                formData.append('files[]', attachments[i]);
            }

            try {
                const response = await fetch(`${baseUrl}/deals?api_token=${apiKey}`, {
                    method: 'POST',
                    body: formData,
                });

                if (response.ok) {
                    alert('Submission successful!');
                } else {
                    console.error('Error:', await response.text());
                    alert('Submission failed. Check the console for details.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            }
        });
    </script>
</body>
</html>
